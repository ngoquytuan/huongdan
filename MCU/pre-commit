#!/bin/bash
#
# Git Pre-Commit Hook - Stack Overflow Prevention
# Place this file in: .git/hooks/pre-commit
# Make executable: chmod +x .git/hooks/pre-commit
#
# This hook automatically checks for common stack overflow issues
# before allowing a commit.
#

echo "=================================="
echo "  Stack Overflow Pre-Commit Check"
echo "=================================="
echo ""

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

ERRORS=0
WARNINGS=0

# Get list of staged C/C++ files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(c|cpp|h|hpp)$')

if [ -z "$STAGED_FILES" ]; then
    echo "No C/C++ files to check."
    exit 0
fi

echo "Checking files:"
for file in $STAGED_FILES; do
    echo "  - $file"
done
echo ""

# =============================================================================
# CHECK 1: Large Local Arrays (> 128 bytes)
# =============================================================================
echo "Check 1: Large local arrays (> 128 bytes)"
echo "----------------------------------------"

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        # Look for local arrays (not static) > 128 bytes
        # Pattern: type name[SIZE] where SIZE > 128
        LARGE_ARRAYS=$(grep -n "^\s*[^/].*\[[2-9][0-9]\{2,\}\]" "$file" | grep -v "static")
        
        if [ ! -z "$LARGE_ARRAYS" ]; then
            echo -e "${YELLOW}‚ö†Ô∏è  WARNING in $file:${NC}"
            echo "$LARGE_ARRAYS" | while read line; do
                echo "  $line"
            done
            echo ""
            ((WARNINGS++))
        fi
    fi
done

if [ $WARNINGS -eq 0 ]; then
    echo -e "${GREEN}‚úÖ No large local arrays detected${NC}"
fi
echo ""

# =============================================================================
# CHECK 2: Printf/LOG_DEBUG with many arguments (> 5)
# =============================================================================
echo "Check 2: Printf/LOG with > 5 arguments"
echo "----------------------------------------"

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        # Count commas in printf/LOG statements
        # This is a simple heuristic
        COMPLEX_LOGS=$(grep -n -E "(printf|sprintf|LOG_DEBUG|LOG_ERROR)" "$file" | \
                       awk -F: '{
                           # Count commas (rough arg count)
                           gsub(/"[^"]*"/, "", $0);  # Remove strings
                           if (gsub(/,/, ",") > 5) print NR": "$0
                       }')
        
        if [ ! -z "$COMPLEX_LOGS" ]; then
            echo -e "${YELLOW}‚ö†Ô∏è  WARNING in $file:${NC}"
            echo "  Printf/LOG with many arguments (high stack usage)"
            echo ""
            ((WARNINGS++))
        fi
    fi
done

if [ $WARNINGS -eq 1 ]; then  # Only 1 from previous check
    echo -e "${GREEN}‚úÖ No complex printf statements detected${NC}"
fi
echo ""

# =============================================================================
# CHECK 3: Potential Recursion
# =============================================================================
echo "Check 3: Potential recursion"
echo "----------------------------------------"

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        # Extract function names
        FUNCTIONS=$(grep -E "^[a-zA-Z_][a-zA-Z0-9_]*\s+[a-zA-Z_][a-zA-Z0-9_]*\s*\(" "$file" | \
                    awk '{print $2}' | cut -d'(' -f1)
        
        # Check if any function calls itself
        for func in $FUNCTIONS; do
            # Look for function calling itself (not in comments)
            SELF_CALL=$(grep -n "[^/]*\b$func\s*(" "$file" | grep -v "^[[:space:]]*//")
            
            if [ $(echo "$SELF_CALL" | wc -l) -gt 1 ]; then
                echo -e "${RED}üö® ERROR in $file:${NC}"
                echo "  Potential recursion detected in function: $func"
                echo ""
                ((ERRORS++))
            fi
        done
    fi
done

if [ $ERRORS -eq 0 ]; then
    echo -e "${GREEN}‚úÖ No recursion detected${NC}"
fi
echo ""

# =============================================================================
# CHECK 4: Malloc in source files (optional warning)
# =============================================================================
echo "Check 4: Dynamic memory allocation"
echo "----------------------------------------"

MALLOC_FOUND=0
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        MALLOC_USAGE=$(grep -n "\bmalloc\b\|\bcalloc\b\|\brealloc\b" "$file" | grep -v "^[[:space:]]*//")
        
        if [ ! -z "$MALLOC_USAGE" ]; then
            echo -e "${YELLOW}‚ö†Ô∏è  INFO in $file:${NC}"
            echo "  Dynamic memory allocation found (review carefully)"
            echo ""
            MALLOC_FOUND=1
        fi
    fi
done

if [ $MALLOC_FOUND -eq 0 ]; then
    echo -e "${GREEN}‚úÖ No dynamic allocation${NC}"
fi
echo ""

# =============================================================================
# SUMMARY
# =============================================================================
echo "=================================="
echo "  Summary"
echo "=================================="
echo -e "Errors:   ${RED}$ERRORS${NC}"
echo -e "Warnings: ${YELLOW}$WARNINGS${NC}"
echo ""

# Block commit if errors found
if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}‚ùå Commit BLOCKED due to critical issues!${NC}"
    echo ""
    echo "Fix the errors above and try again."
    echo "To bypass this check (not recommended): git commit --no-verify"
    echo ""
    exit 1
fi

# Allow commit but warn
if [ $WARNINGS -gt 0 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warnings detected but commit allowed${NC}"
    echo "Please review warnings before pushing."
    echo ""
fi

echo -e "${GREEN}‚úÖ Pre-commit checks passed${NC}"
echo ""
exit 0
